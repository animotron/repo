<?xml version="1.0" encoding="UTF-8"?>
<the:widget-input xmlns:have="animo/relation/have" xmlns:use="animo/relation/use" xmlns:the="animo/instance">
    <have:content>
        <do:xquery xmlns:do="animo/perform">
	        
			declare function local:jscript($widget-id as xs:string, $local-id as xs:string) {
			    let $formId := substring-before($widget-id, "_")
			    return
	    			<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
	    				widgetAutocomplite("{$widget-id}", "{$formId}", "{$local-id}")
	    			</script>
	    	};
	
			let $id := $context/self::have:id/text()
			let $widgetID := translate($id,"/:","__")
			let $localID := $context/self::have:local-id/text()
			let $label :=
			    if ($context/self::have:name) then
        			<label xmlns="http://www.w3.org/1999/xhtml" for="{$widgetID}" id="label_{$widgetID}">
			    		{$context/self::have:name/text()}
			    	</label>
			    else
			    	()
	    	let $input-property := $context/self::have:property
	    	let $input :=
	    		if($input-property/@type eq "reference") then
			    	(
			    	<input xmlns="http://www.w3.org/1999/xhtml" type="text" id="{$widgetID}" value="{$input-property/@value}"/>,
        	<input xmlns="http://www.w3.org/1999/xhtml" type="button" id="new_{$widgetID}" value="+" onclick="javascript:newInstance(&#34;{$localID}&#34;, &#34;{$widgetID}&#34;)"/>,
			    	<input xmlns="http://www.w3.org/1999/xhtml" type="hidden" id="hidden_{$widgetID}" name="the:{$id}" value="{$input-property/@reference}"/>,
			    	<div xmlns="http://www.w3.org/1999/xhtml" id="div_{$widgetID}"/>,
			    	local:jscript($widgetID, $localID)
			    	)
	    		else
	    			<input xmlns="http://www.w3.org/1999/xhtml" type="text" id="{$widgetID}" name="the:{$id}" value="{$input-property/@value}"/>
	    	
			    	
			return
				($label, $input, <br xmlns="http://www.w3.org/1999/xhtml"/>)
	    </do:xquery>
    </have:content>
    <use:jquery-ui-theme/>
    <use:jquery/>
    <use:jquery-ui/>
    <have:script>
        <have:uri>/repository/jquery/utils.js</have:uri>
    </have:script>
    <have:script>
    	function widgetAutocomplite(widgetId, formId, localId) {
			$( "#"+widgetId ).autocomplete({
				source: function( request, response ) {
					$.ajax({
						url: "/an:jsonp-service/an:jquery-ui-autocomplite",
						dataType: "jsonp",
						data: "term_startsWith="+request.term + gatherFieldsValue(formId, localId),
						success: function( data ) {
							response( $.map( data.item, function( item ) {
								return {
									id: item.id,
									label: item.name,
									value: item.name
								}
							}));
						}
					});
				},
				minLength: 1,
				select: function( event, ui ) {
					$( "#hidden_"+widgetId ).val(ui.item.id);
				},
				open: function() {
					$( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
				},
				close: function() {
					$( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
				}
			});
		}
	</have:script>
</the:widget-input>