<?xml version="1.0" encoding="UTF-8"?>
<the:save xmlns:is="animo/relation/is" xmlns:have="animo/relation/have" xmlns:an="animo/reference" xmlns:do="animo/perform" xmlns:the="animo/instance">
    <do:xquery>
        declare function local:save($the-element as element(), $id as xs:string?) {
            let $element-name := $id
            let $save-element :=
                    element {concat("the:", $element-name)} {
                        namespace an {"animo/reference"},
                        namespace is {"animo/relation/is"},
                        namespace have {"animo/relation/have"},
                        element {concat("is:", local-name($the-element))} {},
                            for $sub-element in $the-element/have:*
                            let $namespace := namespace-uri($sub-element)
                            let $local-name := local-name($sub-element)
                            return
                                if($namespace eq "animo/instance") then
                                let $sub-element-id := local:save($sub-element, $sub-element/id/text())
                                    return
                                        element {concat("have:", local-name($sub-element))} {
                                            element {concat("an:", $sub-element-id)} {}
                                        }
                                else if($namespace eq "animo/relation/have") then
                                    let $element := util:eval(concat("//the:", $local-name))
                                    let $sub-element-text := $sub-element/text()
                                    return
                                        if($element and ($sub-element-text ne "")) then
                                            if($element/is:text) then
                                                element {concat("have:", $local-name)} {$sub-element-text}
                                            else
                                                element {concat("have:", $local-name)} {
                                                    element {concat("an:", $sub-element-text)} {}
                                                }
                                        else ()
                                else ()
                    }
                    
            let $store := xmldb:store("/db/animotron/data", concat($element-name, ".xml"), $save-element)
            return $element-name
        };

        let $sense-context := $context/self::the:sense-context
        
        let $store :=
            for $the-element in $sense-context/the:*
            let $id := $the-element/id/text()
            return local:save($the-element, $id)
        return <an:nothing/>
    </do:xquery>
</the:save>